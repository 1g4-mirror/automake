#! /bin/sh
# Copyright (C) 2011 Free Software Foundation, Inc.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# Sanity check for the automake testsuite.
# Check that automatic re-execution of test script with the
# configure-time $SHELL.

required=bash
. ./defs || Exit 1

unset AM_TESTS_REEXEC BASH_VERSION || :

# This is not optimal, but it's much better than writing wrapper
# scripts acting as "fake" shells.

bash -c 'test -n "$BASH_VERSION"' || skip_ "bash shell not found"

for shell in /bin/sh /bin/ksh sh ksh ash dash pdksh __no_shell__; do
  test $shell = __no_shell__ && skip_ "can't find any non-bash shell"
  $shell -c 'exit 0' || continue
  $shell -c 'test -n "$BASH_VERSION"' && continue
  break
done
echo "shell='$shell'"

cwd=`pwd` || Exit 99

cp ../defs .

#
# Check how to default, force or prevent a re-execution.
#

cat > run-with-bash.test <<'END'
#!/bin/false
. ./defs
# Ensure that the script gets re-executed with bash.  Also ensure that
# non-standard syntax used after the inclusion of `./defs' doesn't cause
# non-bash shells to fail.
# Subshell required to prevent some shells (e.g., Solaris 10 /bin/sh)
# from only complaining on stderr but then exiting with exit status 0.
(foo=abac && test xbxc = ${foo//a/x} && test -n "$BASH_VERSION")
END

sed -e "s|^testbuilddir=.*|testbuilddir='$cwd'|" \
    -e 's|^SHELL=.*$|SHELL=bash; export SHELL|' \
    < ../defs-static >defs-static

$shell -x run-with-bash.test

AM_TESTS_REEXEC=''    $shell run-with-bash.test
AM_TESTS_REEXEC=yes   $shell run-with-bash.test
AM_TESTS_REEXEC=y     $shell run-with-bash.test
AM_TESTS_REEXEC=true  $shell run-with-bash.test
AM_TESTS_REEXEC=1     $shell run-with-bash.test
AM_TESTS_REEXEC=no    $shell run-with-bash.test && Exit 1
AM_TESTS_REEXEC=n     $shell run-with-bash.test && Exit 1
AM_TESTS_REEXEC=false $shell run-with-bash.test && Exit 1
AM_TESTS_REEXEC=0     $shell run-with-bash.test && Exit 1

#
# Check message about the re-execution.
#

cat > dummy.test <<'END'
#!/bin/sh
. ./defs
:
END
chmod a+x dummy.test

mkdir sub
cp dummy.test defs sub
sed -e "s|^testbuilddir=.*|testbuilddir='$cwd'|" \
    < ../defs-static > defs-static
sed -e "s|^testbuilddir=.*|testbuilddir='$cwd/sub'|" \
    < ../defs-static > sub/defs-static

./dummy.test a b | grep "^dummy: exec $SHELL \\./dummy\\.test a b$"

for am_sh in $shell bash; do
  $am_sh dummy.test a b c \
    | grep "^dummy: exec $SHELL dummy\\.test a b c$"
  $am_sh ./dummy.test a b c \
    | grep "^dummy: exec $SHELL \\./dummy\\.test a b c$"
  cd sub
  $am_sh ../dummy.test a b \
    | grep "dummy: exec $SHELL \\.\\./dummy\\.test a b$"
  cd ..
  $am_sh "$cwd/dummy.test" a -b c- \
    | grep "^dummy: exec $SHELL $cwd/dummy\\.test a -b c-$"
  $am_sh sub/dummy.test 1 2 3 4 \
    | grep "^dummy: exec $SHELL sub/dummy\\.test 1 2 3 4$"
done

#
# Check that arguments passed to a test script are preserved by a re-exec.
#

cat > checkargs.test <<'END'
. ./defs
test $# -eq 3 && test x"$1" = x'a' && test x"$2" = x && test x"$3" = x"-e"
END

$SHELL checkargs.test a '' -e
$SHELL ./checkargs.test a '' -e
$SHELL "$cwd/checkargs.test" a '' -e
cd sub
$SHELL ../checkargs.test a '' -e
cd ..
cp checkargs.test sub
$SHELL sub/checkargs.test a '' -e

:
