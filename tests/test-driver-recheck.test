#! /bin/sh
# Copyright (C) 2011 Free Software Foundation, Inc.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# Test the "make recheck" semantics for custom test driver, as
# documented in detail in the Automake manual.

parallel_tests=yes
. ./defs || Exit 1

cat >> configure.in << 'END'
AC_OUTPUT
END

cat > Makefile.am << 'END'
LOG_DRIVER = ./dummy-driver
TEST_EXTENSIONS =
TESTS =
END

rechecked=''
notrechecked=''

for R in PASS XFAIL SKIP; do
  echo $R: > $R-1
  echo " $R:" > $R-2
  echo $R:foo > $R-3
  echo "$tab $R: bar baz" > $R-4
  # The :test-result: fields should be irrelevant for the decision of
  # whether "make recheck" should or should not re-run a test.
  unindent > $R-5 <<END
    $R:
    :test-result: FAIL
    :test-result: XPASS
    :test-result: ERROR
END
  notrechecked="$notrechecked $R-1 $R-2 $R-3 $R-4 $R-5"
  echo $R > BAD-$R-1
  echo $R. > BAD-$R-2
  echo :$R: > BAD-$R-3
  echo $R asd > BAD-$R-4
  rechecked="$rechecked BAD-$R-1 BAD-$R-2 BAD-$R-3 BAD-$R-4"
done

for R in FAIL XPASS UNKNOWN; do
  echo $R: > $R-1
  echo $R:foo > $R-2
  echo $R: bar baz > $R-3
  echo $R > $R-4
  echo $R asd > $R-5
  # The :test-result: fields should be irrelevant for the decision of
  # whether "make recheck" should or should not re-run a test.
  unindent > $R-6 <<END
    :test-result: PASS
    :test-result: SKIP
    :test-result: XFAIL
END
  (echo $R: && cat $R-6) > $R-7
  rechecked="$rechecked $R-1 $R-2 $R-3 $R-4 $R-5 $R-6 $R-7"
done

: > EMPTY
echo "  $tab $tab" > WHITE
rechecked="$rechecked EMPTY WHITE"

tests="$rechecked $notrechecked"

for t in $tests; do echo $t; done | sed 's/.*/TESTS += &/' >> Makefile.am

cat Makefile.am # For debugging.

cat > dummy-driver <<'END'
#!/bin/sh
set -e
while test $# -gt 0; do
  case $1 in
    --log-file) log_file=$2; shift;;
    --test-name) test_name=$2; shift;;
    --expect-failure|--color-tests|--enable-hard-errors) shift;;
    --) shift; break;;
     *) echo "$0: invalid option/argument: '$1'" >&2; exit 2;;
  esac
  shift
done
: > $test_name.run
cp $1 $log_file
END
chmod a+x dummy-driver

$ACLOCAL
$AUTOCONF
$AUTOMAKE

./configure

# The ':test-result:' fields should be ignored by "make recheck",
# but should cause the testsuite report to detect errors.
$MAKE check && Exit 1
ls -l
for t in $tests; do test -f $t.run; done
rm -f *.run

# But now the tests that actually get re-run have only ':test-result:'
# fields indicating success, so "make recheck" must pass.  Still, the
# next "make recheck" call should still re-run the same set of tests.
for iteration in 1 2; do
  $MAKE recheck
  ls -l
  for t in $rechecked; do test -f $t.run; done
  for t in $notrechecked; do test ! -r $t.run; done
  rm -f *.run
done

:
