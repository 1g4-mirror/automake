#! /bin/sh
# Copyright (C) 2011 Free Software Foundation, Inc.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# TAP support:
#  - all input (valid TAP lines, invalid TAP lines, non-TAP lines)
#    are passed through in the log file
#  - TAP errors are reported in the log file too
# See also related test 'tap-passthrough-exit.test'.

parallel_tests=yes
. ./defs || Exit 1

cp "$top_testsrcdir"/lib/tap-driver . \
  || fatal_ "failed to fetch auxiliary script tap-driver"

cat >> configure.in <<END
AC_SUBST([PERL], ['$PERL'])
AC_OUTPUT
END

cat > Makefile.am << 'END'
TEST_LOG_DRIVER = $(PERL) $(srcdir)/tap-driver
TEST_LOG_COMPILER = cat
TESTS =
END

weirdchars=\''"\$@!&()[]<>#;,:.^?*/'

$ACLOCAL
$AUTOCONF
$AUTOMAKE

./configure

#
# Only successful tests.
#

# The whitespace in this test might be normalized in the testsuite
# progress output, but should be copied verbatim in the log files.
cat > ok.test <<END
1..6
TAP plan in the previous line.
ok${tab}
ok     2
ok - foo
ok 4 - x
  This is not a TAP line, but should still be copied in the log file!
# some diagnostic${tab}
not ok # TODO low priority
ok # SKIP who cares?
This is not in test-suite.log, since ok.test does not fail.
$weirdchars
END

st=0
TESTS=ok.test $MAKE -e check || st=$?
cat ok.log
cat test-suite.log
test $st -eq 0 || Exit 1

for rx in \
  '1\.\.6' \
  'TAP plan in the previous line\.' \
  "ok${tab}" \
  'ok     2' \
  'ok - foo' \
  'ok 4 - x' \
  '  This is not a TAP line, but should still be copied in the log file!' \
  "# some diagnostic${tab}" \
  'not ok # TODO low priority' \
  'ok # SKIP who cares?' \
  'This is not in test-suite\.log, since ok\.test does not fail\.' \
; do
  grep "^$rx$" ok.log
done
$FGREP "$weirdchars" ok.log

$FGREP 'ok.test' test-suite.log && Exit 1
$FGREP 'not in test-suite.log' test-suite.log && Exit 1

#
# Mixed failing/successful tests.
#

cat > tiny.test <<END
1..1
ok
END

cat > ok.test <<END
1..1
ok
local only
END

cat > ko.test <<END
1..5
foo foo foo
ok${tab}
ok     2
not ok - foo
not ok 4 - x
# diagnostic ko
  bar${tab}bar${tab}bar
ok # TODO dunno
$weirdchars
END

cat > bail.test <<END
Bail out! Test is taking too long!
END

cat > skip.test <<END
1..0 # Skipped: WWW::Mechanize not installed
END

cat > err.test <<END
1..3
ok 1
Invalid test count
ok 23
Misplaced plan
1..13
ok
Extra test
ok
Last line
END

st=0
env TESTS='tiny.test ok.test ko.test bail.test skip.test err.test' \
  $MAKE -e check || st=$?
cat tiny.log
cat ok.log
cat ko.log
cat bail.log
cat skip.log
cat err.log
cat test-suite.log
test $st -gt 0 || Exit 1

grep '^1\.\.1$' tiny.log
grep '^ok$' tiny.log

grep '^local only$' ok.log
grep 'local only' test-suite.log && Exit 1

for rx in \
  '1\.\.5' \
  'foo foo foo' \
  "ok${tab}" \
  'ok     2' \
  'not ok - foo' \
  'not ok 4 - x' \
  '# diagnostic ko' \
  "  bar${tab}bar${tab}bar" \
  'ok # TODO dunno' \
; do
  grep "^$rx$" ko.log
  grep "^$rx$" test-suite.log
done
$FGREP "$weirdchars" ko.log
$FGREP "$weirdchars" test-suite.log

for log in bail.log test-suite.log; do
  grep '^Bail out! Test is taking too long!$' $log
done
for log in skip.log test-suite.log; do
  grep '^1\.\.0 # Skipped: WWW::Mechanize not installed$' $log
done

for rx in \
  '^1\.\.3$' \
  '^Invalid test count$' \
  '^ok 23$' \
  '^Misplaced plan$' \
  '^1\.\.13$' \
  '^ERROR:.* test plan in middle of output' \
   '^Extra test$' \
  '^Last line$' \
  '^ERROR:.* [tT]oo many tests run.*expected 3, got 4' \
  '^ERROR:.* err\.test 23 .*OUT[ -]OF[ -]ORDER.*expecting 2' \
; do
  grep "$rx" err.log
  grep "$rx" test-suite.log
done

:
