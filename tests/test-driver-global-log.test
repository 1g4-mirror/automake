#! /bin/sh
# Copyright (C) 2011 Free Software Foundation, Inc.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# Custom test drivers and parallel-tests harness: check the documented
# semantics for deciding when the content of a test log file should be
# copied in the global test-suite.log file.  Currently, this is done
# with the use of the reStructuredText field `:copy-in-global-log:'.

parallel_tests=yes
. ./defs || Exit 1

cat >> configure.in << 'END'
AC_OUTPUT
END

# The `:test-result:' and `:recheck:' fields and the first line of the
# log file should be be irrelevant for the decision of whether a test
# output is to be copied in the `test-suite.log'.

cat > no-1.test <<END
FAIL: no-1.test
:test-result: SKIP
:copy-in-global-log: no
:test-result: FAIL
:test-result: XPASS
not seen 1
END

for RES in XPASS FAIL XFAIL SKIP ERROR UNKNOWN; do
  unindent > $RES.test <<END
    $RES: $RES.test
    :test-result: $RES
    :copy-in-global-log: no
    not seen $RES
END
done

# In the last line, with leading and trailing whitespace.
cat > no-2.test <<END
:test-result: FAIL
not seen 2
:recheck: yes
:copy-in-global-log:$tab $tab no   $tab
END

# In the first line, with no whitespace.
cat > no-3.test <<END
:copy-in-global-log:no
not seen 3
:test-result: FAIL
END

cat > yes-1.test <<END
PASS: yes-1.test
:test-result: PASS
:copy-in-global-log: yes
seen yes 1
END

# A lacking `:copy-in-global-log:' implies that the content of
# the log file should be copied.
cat > yes-2.test <<END
PASS: y.test
:test-result: PASS
seen yes 2
END

# Corner cases.
echo ':copy-in-global-log:' > corn-1.test
echo "  $tab $tab$tab" > corn-2.test
cat > corn-3.test <<'END'
seen corn 31
:copy-in-global-log:#@%!
seen corn 32
END

echo TEST_LOG_DRIVER = ./dummy-driver > Makefile.am
echo TESTS = *.test >> Makefile.am

cat > dummy-driver <<'END'
#!/bin/sh
set -e
while test $# -gt 0; do
  case $1 in
    --log-file) log_file=$2; shift;;
    --test-name) test_name=$2; shift;;
    --expect-failure|--color-tests|--enable-hard-errors) shift;;
    --) shift; break;;
     *) echo "$0: invalid option/argument: '$1'" >&2; exit 2;;
  esac
  shift
done
cp $1 $log_file
END
chmod a+x dummy-driver

$ACLOCAL
$AUTOCONF
$AUTOMAKE

./configure

# We don't care about the exit status of "make check" here, that
# should be checked in other tests.
$MAKE check || :
cat test-suite.log

grep '^seen yes 1$' test-suite.log
grep '^seen yes 2$' test-suite.log
grep '^seen corn 31$' test-suite.log
grep '^seen corn 32$' test-suite.log
grep '^:copy-in-global-log:$' test-suite.log
grep "^  $tab $tab$tab$" test-suite.log
$FGREP 'not seen' test-suite.log && Exit 1
$EGREP '^(XPASS|FAIL|SKIP|ERROR|UNKNOWN)' test-suite.log && Exit 1
test `grep -c ':test-result:' test-suite.log` -eq 2

:
